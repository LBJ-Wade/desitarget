#!/usr/bin/env python

import os
from desitarget.mtl import get_zcat_dir
from desitarget.lyazcat import get_qn_model_fname, load_qn_model
from desitarget.lyazcat import get_sq_model_fname, load_sq_model
from desitarget.lyazcat import create_zcat, tmark

# ADM set up the DESI default logger.
from desiutil.log import get_logger
log = get_logger()

# EBL get the directory where zbest and coadd files are stored.
zcat_dir = get_zcat_dir()

# EBL retrieve the file names for the QuasarNP and SQUEzE models
#     from environment variables.
qnmodel_fname = get_qn_model_fname()
sqmodel_fname = get_sq_model_fname()

# ADM by default we're working with tiles/cumulative.
sub_dir = os.path.join('tiles', 'cumulative')

# EBL Handy tileid/nightid combos for testing
#    -  1, 20210406, Note: missing petal 7, good test for skipping bad petal.
#    - 84, 20210410
#    - 85, 20210412
# For the VI'd tiles using the processed r_depth_ebvair of ~1000
#    TILEIDs: 80605, 80607, 80609, 80620, 80622
#    NIGHTID: All use 20210302 (when I made those files). Date is
#             meaningless in this case, just there due to filename
#             format requirements.

from argparse import ArgumentParser

arp = ArgumentParser(description='Create a zqso file for tile/night combinations.')
arp.add_argument('tile',
                 help='TILEID(s) of tiles to process. Pass a comma-separated    \
                 list (e.g. 1 for TILE 1 or "1,84,85" for TILEs 1, 84, 85)')
arp.add_argument('night',
                 help='NIGHTID(s) of tiles to process in YYYYMMDD. Pass a comma \
                 -separated list (e.g. 20210406 or "20210406,20210410,20210412")\
                 which must correspond to the TILEIDs')
arp.add_argument('-p', '--petal', 
                 default="0,1,2,3,4,5,6,7,8,9",
                 help='Petals to run. Pass comma-separated integers             \
                 (e.g. "1" for petal 1, "3,5,8" for petals 3, 5 and 8)          \
                 Defaults to 0,1,2,3,4,5,6,7,8,9 (all petals)')
arp.add_argument('-i', '--input_dir',
                 metavar='ZCAT_DIR', default=zcat_dir,
                 help='The root input directory for DESI spectra.               \
                 Defaults to {}'.format(zcat_dir))
arp.add_argument('-o', '--output_dir',
                 metavar='ZCAT_DIR', default=zcat_dir,
                 help='The root output directory for zqso files.                \
                 Defaults to {}'.format(zcat_dir))
arp.add_argument('-sd', '--sub_dir',
                 default=sub_dir,
                 help='The sub-directories that house zbest files.              \
                 Defaults to {}'.format(sub_dir))
arp.add_argument('-noq', '--no_quasarnp',
                 action='store_true',
                 help='QuasarNP is added by default. Send this to NOT add it.')
arp.add_argument('-s', '--add_squeze',
                 action='store_true',
                 help='Add SQUEzE data to zqso file.')
arp.add_argument('-m', '--add_mgii',
                 action='store_true',
                 help='Add MgII absorption data to zqso file.')
arp.add_argument('-zc', '--add_zcomb',
                 action='store_true',
                 help='Add combined redshift information.')
arp.add_argument('-n', '--qn_model',
                 metavar='QN_MODEL_FILE',
                 default=qnmodel_fname,
                 help='The full path and filename for the QuasarNP model        \
                 file. Defaults to {}'.format(qnmodel_fname))
arp.add_argument('-e', '--sqz_model',
                 metavar='SQ_MODEL_FILE',
                 default=sqmodel_fname,
                 help='The full path and filename for the SQUEzE model          \
                 file. Defaults to {}'.format(sqmodel_fname))
args = arp.parse_args()

add_quasarnp = not(args.no_quasarnp)
print(add_quasarnp)

# EBL Load the QuasarNP model file if QuasarNP is activated.
if add_quasarnp:
    tmark('    Loading QuasarNP Model file')
    qnp_model, qnp_lines, qnp_lines_bal = load_qn_model(args.qn_model)
    tmark('      QNP model file loaded')
else:
    qnp_model, qnp_lines, qnp_lines_bal = None, None, None

if args.add_squeze:
    tmark('    Loading SQUEzE Model file')
    sq_model = load_sq_model(args.sqz_model)
    tmark('      Model file loaded')
else:
    sq_model = None

# ADM add, e.g., tiles/cumulative to the directory structure.
input_dir = os.path.join(args.input_dir, args.sub_dir)
output_dir = os.path.join(args.output_dir, args.sub_dir)

tiles = [t for t in args.tile.split(',')]
nights = [n for n in args.night.split(',')]
petals = [p for p in args.petal.split(',')]

for tile, night in zip(tiles, nights):
    for pnum in petals:
        log.info("processing TILEID={}, NIGHTID={}, petal={}".format(
            tile, night, pnum))
        create_zcat(tile, night, pnum,
                    zcatdir=input_dir, outputdir=output_dir,
                    qn_flag=add_quasarnp, qnp_model=qnp_model,
                    qnp_lines=qnp_lines, qnp_lines_bal=qnp_lines_bal,
                    sq_flag=args.add_squeze, squeze_model=sq_model,
                    abs_flag=args.add_mgii, zcomb_flag=args.add_zcomb)
